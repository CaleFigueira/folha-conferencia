<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria Folha - Sistema Completo</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useMemo } = React;
        
        const Upload = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>;
        const CheckCircle = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>;
        const AlertCircle = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>;
        const X = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg>;

        const AuditEngine = {
          equivalenciaFerias: { '6262': '5262', '6254': '5254', '6281': '5281', '6272': '5272', '5020': '5023' },
          
          limpar: (str) => {
            return str.toLowerCase()
              .replace(/[√°√†√£√¢√§]/g, 'a').replace(/[√©√®√™√´]/g, 'e').replace(/[√≠√¨√Æ√Ø]/g, 'i')
              .replace(/[√≥√≤√µ√¥√∂]/g, 'o').replace(/[√∫√π√ª√º]/g, 'u').replace(/√ß/g, 'c')
              .replace(/[^a-z0-9]/g, '');
          },
          
          // Busca com ESPA√áOS permitidos
          buscarCampoEspacos: (row, palavrasChave) => {
            const keys = Object.keys(row);
            
            for (let palavraOriginal of palavrasChave) {
              // Normaliza mas MANT√âM espa√ßos para compara√ß√£o
              const palavraNorm = palavraOriginal.toLowerCase()
                .replace(/[√°√†√£√¢√§]/g, 'a').replace(/[√©√®√™√´]/g, 'e').replace(/[√≠√¨√Æ√Ø]/g, 'i')
                .replace(/[√≥√≤√µ√¥√∂]/g, 'o').replace(/[√∫√π√ª√º]/g, 'u').replace(/√ß/g, 'c')
                .replace(/[ÔøΩ]/g, ''); // Remove caracteres quebrados
              
              for (let key of keys) {
                const keyNorm = key.toLowerCase()
                  .replace(/[√°√†√£√¢√§]/g, 'a').replace(/[√©√®√™√´]/g, 'e').replace(/[√≠√¨√Æ√Ø]/g, 'i')
                  .replace(/[√≥√≤√µ√¥√∂]/g, 'o').replace(/[√∫√π√ª√º]/g, 'u').replace(/√ß/g, 'c')
                  .replace(/[ÔøΩ]/g, '');
                
                if (keyNorm.includes(palavraNorm)) {
                  const valor = row[key];
                  if (valor && valor.toString().trim() !== '') {
                    return valor.toString().trim();
                  }
                }
              }
            }
            return null;
          },
          
          normalizarMatricula: (row) => {
            const resultado = AuditEngine.buscarCampoEspacos(row, [
              'matricula colaborador', 
              'matr√≠cula colaborador',
              'matricula', 
              'matr√≠cula',
              'mat',
              'matr',
              'mat col'
            ]);
            return resultado;
          },
          
          extrairValor: (row) => {
            const valorStr = AuditEngine.buscarCampoEspacos(row, [
              'valor',
              'valor mensal',
              'valor calculado',
              'val',
              'amount'
            ]);
            if (!valorStr) return 0;
            const val = valorStr.replace(/\./g, '').replace(',', '.');
            return parseFloat(val) || 0;
          },
          
          extrairCodigoEvento: (row) => {
            const resultado = AuditEngine.buscarCampoEspacos(row, [
              'codigo evento',
              'c√≥digo evento',
              'codigoevento',
              'c√≥digo',
              'cod evento', 
              'cod',
              'codev',
              'event code',
              'c√≥digo rubrica',
              'c√≥digo r√∫brica'
            ]);
            return resultado;
          },
          
          extrairNomeColaborador: (row) => {
            return AuditEngine.buscarCampoEspacos(row, [
              'nome colaborador',
              'nome do colaborador', 
              'colaborador',
              'nome',
              'employee name',
              'funcion√°rio'
            ]);
          },

          extrairTipoEvento: (row) => {
            return AuditEngine.buscarCampoEspacos(row, ['tipo evento', 'Tipo Evento', 'type event']) || 'N/A';
          },

          extrairNomeEvento: (row) => {
            return AuditEngine.buscarCampoEspacos(row, ['evento', 'Evento', 'event', 'nome evento']) || 'N/A';
          },

          extrairCodigoFolha: (row) => {
            return AuditEngine.buscarCampoEspacos(row, ['codigo folha', 'C√≥digo Folha', 'c√≥digo folha', 'folha', 'code']) || 'N/A';
          },
          
          criarIndiceEventos: (folha, label) => {
            console.log(`\nüîß ${label}...`);
            
            if (folha.length === 0) {
              console.log(`   ‚ö†Ô∏è  Folha vazia!`);
              return {};
            }
            
            const colunas = Object.keys(folha[0]).filter(k => k !== '_lineNumber');
            console.log(`   üìã ${colunas.length} colunas detectadas`);
            
            // Log todas as colunas para debug
            if (colunas.length <= 20) {
              console.log(`   üìå Colunas: [${colunas.join(' | ')}]`);
            } else {
              console.log(`   üìå Primeiras 10: [${colunas.slice(0, 10).join(' | ')}...]`);
            }
            
            const indice = {};
            let registrosValidos = 0;
            let semMatricula = 0;
            let semCodigo = 0;
            let semValor = 0;
            let erros = [];
            
            folha.forEach((row, idx) => {
              const matricula = AuditEngine.normalizarMatricula(row);
              const codigo = AuditEngine.extrairCodigoEvento(row);
              const valor = AuditEngine.extrairValor(row);
              
              if (idx === 0) {
                console.log(`   üîç [REG 1] mat="${matricula}" cod="${codigo}" val=${valor}`);
                if (!matricula) console.log(`      ‚ö†Ô∏è  Campo de matr√≠cula n√£o encontrado`);
                if (!codigo) console.log(`      ‚ö†Ô∏è  Campo de c√≥digo n√£o encontrado`);
                if (valor === 0) console.log(`      ‚ö†Ô∏è  Campo de valor n√£o encontrado ou √© 0`);
              }
              
              if (!matricula) { 
                semMatricula++; 
                if (semMatricula <= 2) erros.push(`Linha ${idx + 2}: SEM MATR√çCULA (colunas: ${colunas.slice(0,3).join(',')})`);
                return; 
              }
              if (!codigo) { 
                semCodigo++; 
                if (semCodigo <= 2) erros.push(`Linha ${idx + 2}: SEM C√ìDIGO (mat=${matricula})`);
                return; 
              }
              
              registrosValidos++;
              if (!indice[matricula]) indice[matricula] = {};
              if (!indice[matricula][codigo]) indice[matricula][codigo] = [];
              
              indice[matricula][codigo].push({ 
                valor, 
                linha: row._lineNumber || idx + 2, 
                nome: AuditEngine.extrairNomeColaborador(row),
                dados: row 
              });
            });
            
            const totalMat = Object.keys(indice).length;
            const totalEvt = Object.values(indice).reduce((s, e) => 
              s + Object.values(e).reduce((ss, o) => ss + o.length, 0), 0
            );
            
            console.log(`   ‚úÖ ${registrosValidos} v√°lidos | ${totalMat} matr√≠culas | ${totalEvt} eventos`);
            if (semMatricula > 0) console.log(`   ‚ùå ${semMatricula} registros SEM MATR√çCULA`);
            if (semCodigo > 0) console.log(`   ‚ùå ${semCodigo} registros SEM C√ìDIGO`);
            if (erros.length > 0) {
              console.log(`   üìù Problemas encontrados:`);
              erros.forEach(e => console.log(`      - ${e}`));
            }
            
            if (totalMat > 0) {
              const amostra = Object.keys(indice)[0];
              const evts = Object.keys(indice[amostra]).slice(0, 5);
              const amostraEvt = indice[amostra][evts[0]];
              console.log(`   üìä Amostra - Mat ${amostra}: ${evts.length} tipos evento`);
              console.log(`      Codes: [${evts.join(', ')}]`);
              console.log(`      Primeiro evento: C√≥digo ${evts[0]}, ${amostraEvt.length} ocorr√™ncias, R$ ${amostraEvt.reduce((s,o)=>s+o.valor,0).toFixed(2)}`);
            }
            
            return indice;
          },
          
          executarAuditoria: (folhaAtual, folhaAnterior, baseAdmitidos, baseDemitidos, baseFerias, baseLicenciados) => {
            console.log('\n' + '='.repeat(50));
            console.log('üîç AUDITORIA CSB');
            console.log('='.repeat(50));
            
            const indiceAtual = AuditEngine.criarIndiceEventos(folhaAtual, 'FOLHA ATUAL');
            const indiceAnterior = AuditEngine.criarIndiceEventos(folhaAnterior, 'FOLHA ANTERIOR');
            
            console.log(`\nüìä ${Object.keys(indiceAtual).length} vs ${Object.keys(indiceAnterior).length} matr√≠culas`);
            
            // R1
            console.log('\n‚îÅ‚îÅ‚îÅ R1: EVENTOS NOVOS ‚îÅ‚îÅ‚îÅ');
            const r1 = [];
            for (const [mat, evts] of Object.entries(indiceAtual)) {
              for (const [cod, ocs] of Object.entries(evts)) {
                const existia = indiceAnterior[mat]?.[cod];
                const equiv = AuditEngine.equivalenciaFerias[cod];
                const temEquiv = equiv && indiceAnterior[mat]?.[equiv];
                
                if (!existia && !temEquiv) {
                  ocs.forEach(oc => {
                    r1.push({
                      regra: 'R1', tipo: 'EVENTO_NOVO', 
                      severidade: oc.valor > 1000 ? 'ALTA' : 'MEDIA',
                      matricula: mat, codigoFolha: AuditEngine.extrairCodigoFolha(oc.dados), 
                      tipoEvento: AuditEngine.extrairTipoEvento(oc.dados),
                      codigoEvento: cod, 
                      nomeEvento: AuditEngine.extrairNomeEvento(oc.dados),
                      valor: oc.valor,
                      descricao: `Novo: ${cod}`, 
                      impacto: oc.valor
                    });
                  });
                }
              }
            }
            console.log(`‚úÖ ${r1.length} diverg√™ncias`);
            
            // R2
            console.log('\n‚îÅ‚îÅ‚îÅ R2: EVENTOS REMOVIDOS ‚îÅ‚îÅ‚îÅ');
            const r2 = [];
            for (const [mat, evts] of Object.entries(indiceAnterior)) {
              for (const [cod, ocs] of Object.entries(evts)) {
                const existe = indiceAtual[mat]?.[cod];
                const equivInv = Object.keys(AuditEngine.equivalenciaFerias)
                  .find(k => AuditEngine.equivalenciaFerias[k] === cod);
                const temEquiv = equivInv && indiceAtual[mat]?.[equivInv];
                
                if (!existe && !temEquiv) {
                  ocs.forEach(oc => {
                    r2.push({
                      regra: 'R2', tipo: 'EVENTO_REMOVIDO',
                      severidade: oc.valor > 1000 ? 'ALTA' : 'MEDIA',
                      matricula: mat, codigoFolha: AuditEngine.extrairCodigoFolha(oc.dados), 
                      tipoEvento: AuditEngine.extrairTipoEvento(oc.dados),
                      codigoEvento: cod, 
                      nomeEvento: AuditEngine.extrairNomeEvento(oc.dados),
                      valorAnterior: oc.valor,
                      descricao: `Removido: ${cod}`,
                      impacto: -oc.valor
                    });
                  });
                }
              }
            }
            console.log(`‚úÖ ${r2.length} diverg√™ncias`);
            
            // R3
            console.log('\n‚îÅ‚îÅ‚îÅ R3: VALOR ALTERADO ‚îÅ‚îÅ‚îÅ');
            const r3 = [];
            const tol = 5;
            for (const [mat, evts] of Object.entries(indiceAtual)) {
              for (const [cod, ocsAtual] of Object.entries(evts)) {
                const ocsAnt = indiceAnterior[mat]?.[cod];
                if (!ocsAnt) continue;
                
                const valAtual = ocsAtual.reduce((s, o) => s + o.valor, 0);
                const valAnt = ocsAnt.reduce((s, o) => s + o.valor, 0);
                const var_ = valAtual - valAnt;
                const varPerc = valAnt !== 0 ? (var_ / valAnt) * 100 : 0;
                
                if (Math.abs(varPerc) > tol && Math.abs(var_) > 10) {
                  r3.push({
                    regra: 'R3', tipo: 'VALOR_ALTERADO',
                    severidade: Math.abs(varPerc) > 20 ? 'ALTA' : 'MEDIA',
                    matricula: mat, codigoFolha: AuditEngine.extrairCodigoFolha(ocsAtual[0].dados),
                    tipoEvento: AuditEngine.extrairTipoEvento(ocsAtual[0].dados),
                    codigoEvento: cod, 
                    nomeEvento: AuditEngine.extrairNomeEvento(ocsAtual[0].dados),
                    valorAnterior: valAnt, valorAtual: valAtual,
                    variacao: var_, variacaoPerc: varPerc,
                    descricao: `${cod} variou ${Math.abs(varPerc).toFixed(1)}%`,
                    impacto: var_
                  });
                }
              }
            }
            console.log(`‚úÖ ${r3.length} diverg√™ncias`);
            
            // R7
            console.log('\n‚îÅ‚îÅ‚îÅ R7: DUPLICADOS ‚îÅ‚îÅ‚îÅ');
            const r7 = [];
            for (const [mat, evts] of Object.entries(indiceAtual)) {
              for (const [cod, ocs] of Object.entries(evts)) {
                if (ocs.length > 1) {
                  r7.push({
                    regra: 'R7', tipo: 'EVENTO_DUPLICADO', severidade: 'ALTA',
                    matricula: mat, codigoFolha: AuditEngine.extrairCodigoFolha(ocs[0].dados),
                    tipoEvento: AuditEngine.extrairTipoEvento(ocs[0].dados),
                    codigoEvento: cod, 
                    nomeEvento: AuditEngine.extrairNomeEvento(ocs[0].dados),
                    quantidadeOcorrencias: ocs.length,
                    descricao: `${cod} repetido ${ocs.length}x`,
                    impacto: ocs.reduce((s, o) => s + o.valor, 0)
                  });
                }
              }
            }
            console.log(`‚úÖ ${r7.length} diverg√™ncias`);
            
            // R5
            console.log('\n‚îÅ‚îÅ‚îÅ R5: ADMITIDOS ‚îÅ‚îÅ‚îÅ');
            const r5 = [];
            const matsAdm = new Set(baseAdmitidos.map(r => AuditEngine.normalizarMatricula(r)).filter(Boolean));
            console.log(`   üìå ${matsAdm.size} matr√≠culas de admitidos`);
            matsAdm.forEach(mat => {
              // Admitido deve estar na folha atual
              if (!indiceAtual[mat]) {
                r5.push({ 
                  regra: 'R5', tipo: 'ADMITIDO_NAO_NA_FOLHA_ATUAL', severidade: 'ALTA',
                  matricula: mat, descricao: 'Admitido n√£o consta na folha atual', impacto: 0 
                });
              }
              // Admitido N√ÉO deve estar na folha anterior
              if (indiceAnterior[mat]) {
                r5.push({ 
                  regra: 'R5', tipo: 'ADMITIDO_EXISTIA_ANTES', severidade: 'ALTA',
                  matricula: mat, descricao: 'Admitido j√° existia na folha anterior', impacto: 0 
                });
              }
            });
            console.log(`‚úÖ ${r5.length} diverg√™ncias`);
            
            // R6
            console.log('\n‚îÅ‚îÅ‚îÅ R6: DEMITIDOS ‚îÅ‚îÅ‚îÅ');
            const r6 = [];
            const matsDem = new Set(baseDemitidos.map(r => AuditEngine.normalizarMatricula(r)).filter(Boolean));
            console.log(`   üìå ${matsDem.size} matr√≠culas de demitidos`);
            matsDem.forEach(mat => {
              // Demitido PODE estar na folha atual, mas APENAS com c√≥digos de rescis√£o (9000-9003)
              if (indiceAtual[mat]) {
                const evts = Object.keys(indiceAtual[mat]);
                const codsRescisao = evts.filter(c => ['9000','9001','9002','9003'].includes(c));
                const codsOutros = evts.filter(c => !['9000','9001','9002','9003'].includes(c));
                
                if (codsOutros.length > 0) {
                  r6.push({ 
                    regra: 'R6', tipo: 'DEMITIDO_COM_EVENTOS_NAO_RESCISAO', severidade: 'ALTA',
                    matricula: mat, descricao: `Demitido com ${codsOutros.length} evento(s) n√£o rescis√£o`, impacto: 0 
                  });
                }
              } else {
                // Demitido que n√£o consta na folha atual
                r6.push({ 
                  regra: 'R6', tipo: 'DEMITIDO_AUSENTE', severidade: 'MEDIA',
                  matricula: mat, descricao: 'Demitido ausente na folha atual', impacto: 0 
                });
              }
            });
            console.log(`‚úÖ ${r6.length} diverg√™ncias`);
            
            const todas = [...r1, ...r2, ...r3, ...r5, ...r6, ...r7];
            
            const metricas = {
              total: todas.length,
              porSeveridade: {
                ALTA: todas.filter(d => d.severidade === 'ALTA').length,
                MEDIA: todas.filter(d => d.severidade === 'MEDIA').length,
              },
              porRegra: { R1: r1.length, R2: r2.length, R3: r3.length, R5: r5.length, R6: r6.length, R7: r7.length },
              impactoFinanceiro: {
                total: todas.reduce((s, d) => s + (d.impacto || 0), 0),
                positivo: todas.filter(d => (d.impacto || 0) > 0).reduce((s, d) => s + d.impacto, 0),
                negativo: todas.filter(d => (d.impacto || 0) < 0).reduce((s, d) => s + d.impacto, 0)
              }
            };
            
            console.log('\n' + '='.repeat(50));
            console.log(`‚úÖ TOTAL: ${metricas.total} diverg√™ncias`);
            console.log(`üî¥ ${metricas.porSeveridade.ALTA} alta | üü° ${metricas.porSeveridade.MEDIA} m√©dia`);
            console.log(`üí∞ R$ ${metricas.impactoFinanceiro.total.toFixed(2)}`);
            console.log('='.repeat(50));
            
            return { divergencias: todas, metricas };
          }
        };

        const PayrollAuditApp = () => {
          const [etapa, setEtapa] = useState('upload');
          const [arquivos, setArquivos] = useState({});
          const [stats, setStats] = useState({});
          const [resultados, setResultados] = useState(null);
          const [rubraSelecionada, setRubraSelecionada] = useState(null);
          const [segmentoSelecionado, setSegmentoSelecionado] = useState(null);
          const [colunasVisivel, setColunasVisivel] = useState(['codigo_folha', 'matricula', 'tipoEvento', 'codigo', 'nomeEvento', 'valor']);
          const [colunasLargura, setColunasLargura] = useState({ codigo_folha: 120, matricula: 120, tipoEvento: 150, codigo: 100, nomeEvento: 150, valor: 100 });

          const fmt = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);

          const calcStats = (rows, tipo) => {
            const mats = new Set();
            let total = 0;
            rows.forEach(r => {
              const m = AuditEngine.normalizarMatricula(r);
              if (m) mats.add(m);
              if (tipo.includes('folha')) total += AuditEngine.extrairValor(r);
            });
            return { totalRegistros: rows.length, colaboradores: mats.size, totalValor: tipo.includes('folha') ? total : null };
          };

          // Descri√ß√£o das regras
          const descricoes = {
            'R1': 'Detecta eventos novos que n√£o existiam na folha anterior',
            'R2': 'Detecta eventos removidos que existiam antes e sumiram',
            'R3': 'Detecta varia√ß√µes de valor superiores a 5% ou R$10',
            'R5': 'Valida se admitidos constam na folha atual e n√£o na anterior',
            'R6': 'Valida se demitidos cont√™m apenas c√≥digos de rescis√£o (9000-9003)',
            'R7': 'Detecta eventos duplicados na mesma matr√≠cula/c√≥digo'
          };

          // Segmenta√ß√£o por tipo - SEMPRE executado (n√£o dentro de condicional)
          const divergPorTipo = useMemo(() => {
            if (!resultados?.divergencias?.length) return {
              'ferias': { nome: 'üèñÔ∏è Com F√©rias no M√™s', count: 0, divs: [] },
              'admitidos': { nome: 'üëã Admitidos no M√™s', count: 0, divs: [] },
              'demitidos': { nome: 'üíî Demitidos no M√™s', count: 0, divs: [] },
              'licenciados': { nome: 'ü•º Licenciados no M√™s', count: 0, divs: [] }
            };
            
            const tipos = {};
            const ferias = (arquivos.ferias?.rows || []).map(r => AuditEngine.normalizarMatricula(r)).filter(Boolean);
            const admitidos = (arquivos.admitidos?.rows || []).map(r => AuditEngine.normalizarMatricula(r)).filter(Boolean);
            const demitidos = (arquivos.demitidos?.rows || []).map(r => AuditEngine.normalizarMatricula(r)).filter(Boolean);
            const licenciados = (arquivos.licenciados?.rows || []).map(r => AuditEngine.normalizarMatricula(r)).filter(Boolean);

            tipos['ferias'] = { nome: 'üèñÔ∏è Com F√©rias no M√™s', count: 0, divs: [] };
            tipos['admitidos'] = { nome: 'üëã Admitidos no M√™s', count: 0, divs: [] };
            tipos['demitidos'] = { nome: 'üíî Demitidos no M√™s', count: 0, divs: [] };
            tipos['licenciados'] = { nome: 'ü•º Licenciados no M√™s', count: 0, divs: [] };

            resultados.divergencias.forEach(d => {
              const matStr = d.matricula.toString();
              if (ferias.includes(matStr)) {
                tipos['ferias'].divs.push(d);
                tipos['ferias'].count++;
              }
              if (admitidos.includes(matStr)) {
                tipos['admitidos'].divs.push(d);
                tipos['admitidos'].count++;
              }
              if (demitidos.includes(matStr)) {
                tipos['demitidos'].divs.push(d);
                tipos['demitidos'].count++;
              }
              if (licenciados.includes(matStr)) {
                tipos['licenciados'].divs.push(d);
                tipos['licenciados'].count++;
              }
            });

            return tipos;
          }, [resultados?.divergencias?.length, arquivos.ferias?.rows?.length, arquivos.admitidos?.rows?.length, arquivos.demitidos?.rows?.length, arquivos.licenciados?.rows?.length, resultados, arquivos]);

          // Segmenta√ß√£o FILTRADA por regra selecionada
          const divergPorTipoFiltrado = useMemo(() => {
            if (!rubraSelecionada || !resultados?.divergencias?.length) return divergPorTipo;
            
            const tipos = {};
            const ferias = (arquivos.ferias?.rows || []).map(r => AuditEngine.normalizarMatricula(r)).filter(Boolean);
            const admitidos = (arquivos.admitidos?.rows || []).map(r => AuditEngine.normalizarMatricula(r)).filter(Boolean);
            const demitidos = (arquivos.demitidos?.rows || []).map(r => AuditEngine.normalizarMatricula(r)).filter(Boolean);
            const licenciados = (arquivos.licenciados?.rows || []).map(r => AuditEngine.normalizarMatricula(r)).filter(Boolean);

            tipos['ferias'] = { nome: 'üèñÔ∏è Com F√©rias no M√™s', count: 0, divs: [] };
            tipos['admitidos'] = { nome: 'üëã Admitidos no M√™s', count: 0, divs: [] };
            tipos['demitidos'] = { nome: 'üíî Demitidos no M√™s', count: 0, divs: [] };
            tipos['licenciados'] = { nome: 'ü•º Licenciados no M√™s', count: 0, divs: [] };

            // Apenas diverg√™ncias da regra selecionada
            resultados.divergencias
              .filter(d => d.regra === rubraSelecionada)
              .forEach(d => {
                const matStr = d.matricula.toString();
                if (ferias.includes(matStr)) {
                  tipos['ferias'].divs.push(d);
                  tipos['ferias'].count++;
                }
                if (admitidos.includes(matStr)) {
                  tipos['admitidos'].divs.push(d);
                  tipos['admitidos'].count++;
                }
                if (demitidos.includes(matStr)) {
                  tipos['demitidos'].divs.push(d);
                  tipos['demitidos'].count++;
                }
                if (licenciados.includes(matStr)) {
                  tipos['licenciados'].divs.push(d);
                  tipos['licenciados'].count++;
                }
              });

            return tipos;
          }, [rubraSelecionada, resultados?.divergencias?.length, arquivos.ferias?.rows?.length, arquivos.admitidos?.rows?.length, arquivos.demitidos?.rows?.length, arquivos.licenciados?.rows?.length, resultados, arquivos]);

          // Filtrar diverg√™ncias baseado em sele√ß√µes - SEMPRE executado
          const divergFiltered = useMemo(() => {
            if (!resultados?.divergencias) return [];
            
            let result = [...resultados.divergencias];
            
            if (rubraSelecionada) {
              result = result.filter(d => d.regra === rubraSelecionada);
            }
            
            if (segmentoSelecionado) {
              const tiposRef = rubraSelecionada ? divergPorTipoFiltrado : divergPorTipo;
              if (tiposRef[segmentoSelecionado]) {
                const segDivs = tiposRef[segmentoSelecionado].divs;
                result = result.filter(d => segDivs.includes(d));
              }
            }
            
            return result;
          }, [resultados?.divergencias?.length, rubraSelecionada, segmentoSelecionado, divergPorTipo, divergPorTipoFiltrado]);

          const exportarCSV = () => {
            if (!divergFiltered || divergFiltered.length === 0) {
              alert('Nenhuma diverg√™ncia para exportar');
              return;
            }
            const linhas = [['C√≥digo Folha', 'Matr√≠cula', 'Tipo Evento', 'C√≥digo Evento', 'Evento', 'Valor']];
            divergFiltered.forEach(d => {
              linhas.push([
                d.codigoFolha || 'N/A',
                d.matricula,
                d.tipoEvento || 'N/A',
                d.codigoEvento || 'N/A',
                d.nomeEvento || 'N/A',
                d.impacto || ''
              ]);
            });
            const csv = linhas.map(l => l.map(v => `"${v}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `divergencias_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
          };

          const handleUpload = async (tipo, e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
              // Ler como ArrayBuffer e tentar decodificar com UTF-8, cair para windows-1252 se necess√°rio
              const buffer = await file.arrayBuffer();
              let decoder = new TextDecoder('utf-8');
              let text = decoder.decode(buffer);
              let usedEncoding = 'utf-8';

              // Se houver muitos caracteres de substitui√ß√£o ÔøΩ (U+FFFD), tentar windows-1252
              const replacementCount = (text.match(/ÔøΩ/g) || []).length;
              if (replacementCount > 0) {
                try {
                  decoder = new TextDecoder('windows-1252');
                  text = decoder.decode(buffer);
                  usedEncoding = 'windows-1252';
                } catch (e) {
                  // fallback mantido como utf-8
                }
              }

              const rawLines = text.split(/\r?\n/);
              const lines = rawLines.filter(l => l && l.trim().length > 0);

              if (lines.length < 1) {
                console.error(`‚ùå ${tipo}: Arquivo vazio ou inv√°lido`);
                return;
              }

              console.log(`üì• ${tipo}: Analisando arquivo...`);
              console.log(`   Decoded with: ${usedEncoding}`);
              console.log(`   Primeiras 200 chars: ${lines[0].substring(0, 200)}...`);

              // Detectar delimitador examinando primeiras linhas
              const sample = lines.slice(0, Math.min(6, lines.length));
              const score = { ';': 0, ',': 0, '\t': 0 };
              sample.forEach(l => {
                score[';'] += (l.match(/;/g) || []).length;
                score[','] += (l.match(/,/g) || []).length;
                score['\t'] += (l.match(/\t/g) || []).length;
              });
              let delimiter = Object.entries(score).sort((a,b)=>b[1]-a[1])[0][0];
              if (!delimiter) delimiter = ';';
              console.log(`   Delimitador detectado: '${delimiter}' (tentativa autom√°tica)`);

              // Fun√ß√£o para normalizar texto simples (sem remover espa√ßos)
              const norm = (s) => s.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/["\s\uFFFD]/g, '').replace(/[^a-z0-9]/g, '');

              // Detectar a linha real de cabe√ßalho: preferir linha que contenha palavras-chave
              let headerIndex = 0;
              for (let i = 0; i < Math.min(6, lines.length); i++) {
                const cols = lines[i].split(delimiter).map(h => h.replace(/"/g, '').trim());
                if (cols.length >= 3) {
                  const joined = cols.join(' ');
                  const n = norm(joined);
                  if (/(matricul|matr|colaborador|nome|codigo|evento|valor)/.test(n)) {
                    headerIndex = i;
                    break;
                  }
                }
                // fallback: linha que tem similar quantidade de colunas com a pr√≥xima linha
                if (i < lines.length - 1) {
                  const c1 = lines[i].split(delimiter).length;
                  const c2 = lines[i+1].split(delimiter).length;
                  if (c1 >= 3 && Math.abs(c1 - c2) <= 2) { headerIndex = i; break; }
                }
              }

              const headerLine = lines[headerIndex];
              console.log(`   Cabe√ßalho escolhido: linha ${headerIndex + 1}`);
              console.log(`   Primeira linha do cabe√ßalho (bruta): ${headerLine.substring(0,200)}...`);

              const header = headerLine.split(delimiter).map(h => h.replace(/"/g, '').trim());
              console.log(`üìä ${header.length} colunas encontradas`);
              console.log(`   Colunas: [${header.slice(0, 8).map((c, i) => `${i+1}:"${c}"`).join(', ')}...]`);

              if (header.length === 1) {
                console.warn(`‚ö†Ô∏è  Poss√≠vel problema de delimitador - apenas 1 coluna detectada`);
              }

              // Construir linhas de dados a partir de headerIndex+1
              const dataLines = lines.slice(headerIndex + 1);

              const rows = dataLines.map((line, idx) => {
                const vals = line.split(delimiter).map(v => v.replace(/"/g, '').trim());
                const row = { _lineNumber: headerIndex + 2 + idx };

                // Log primeiro registro para debug
                if (idx === 0) {
                  console.log(`   üìù Primeiro registro (${vals.length} valores):`);
                  vals.slice(0, 5).forEach((v, i) => {
                    console.log(`      [${i}] = "${v}"`);
                  });
                }

                header.forEach((h, i) => { row[h] = vals[i] || ''; });
                return row;
              }).filter(r => Object.values(r).some(v => v && v.toString().trim() !== ''));

              console.log(`   ‚úÖ ${rows.length} registros carregados`);
              setArquivos(p => ({ ...p, [tipo]: { nome: file.name, rows } }));
              setStats(p => ({ ...p, [tipo]: calcStats(rows, tipo) }));
            } catch (err) {
              console.error(`‚ùå Erro ao processar ${tipo}:`, err);
              alert(`Erro ao carregar ${tipo}: ${err.message}`);
            }
          };

          const remover = (tipo) => {
            const a = { ...arquivos }; delete a[tipo];
            const s = { ...stats }; delete s[tipo];
            setArquivos(a); setStats(s);
          };

          const executar = () => {
            try {
              console.clear();
              console.log('üöÄ Iniciando auditoria...');
              console.log('Etapa atual:', etapa);
              console.log('Arquivos:', Object.keys(arquivos));
              setEtapa('proc');
              console.log('Etapa definida para: proc');
              
              setTimeout(() => {
                try {
                  console.log('‚è≥ Iniciando processamento de auditoria...');
                  const res = AuditEngine.executarAuditoria(
                    arquivos.folha_atual?.rows || [], 
                    arquivos.folha_anterior?.rows || [],
                    arquivos.admitidos?.rows || [], 
                    arquivos.demitidos?.rows || [],
                    arquivos.ferias?.rows || [], 
                    arquivos.licenciados?.rows || []
                  );
                  
                  console.log('‚úÖ Auditoria conclu√≠da:', res);
                  setResultados(res);
                  console.log('Resultados definidos, etapa ser√° alterada para: res');
                  setEtapa('res');
                  console.log('Etapa alterada para: res');
                } catch (err) {
                  console.error('‚ùå Erro durante auditoria:', err);
                  console.error('Stack:', err.stack);
                  alert(`Erro: ${err.message}`);
                  setEtapa('upload');
                }
              }, 1500);
            } catch (err) {
              console.error('‚ùå Erro ao iniciar auditoria:', err);
              alert(`Erro: ${err.message}`);
            }
          };

          if (etapa === 'proc') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center">
                <div className="bg-white rounded-xl shadow-lg p-12 text-center">
                  <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mx-auto mb-4"></div>
                  <h2 className="text-2xl font-bold mb-2">‚è≥ Processando</h2>
                  <p className="text-slate-600">Executando R1-R7...</p>
                </div>
              </div>
            );
          }

          if (etapa === 'res' && resultados) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-8">
                <div className="max-w-7xl mx-auto space-y-6">
                  <div className="bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl p-6 flex justify-between items-center">
                    <h2 className="text-2xl font-bold">üìã An√°lise de Valida√ß√µes - CSB Drogarias</h2>
                    <button onClick={exportarCSV} className="bg-white text-purple-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-100">
                      üì• Exportar CSV
                    </button>
                  </div>

                  <div className="grid grid-cols-4 gap-4">
                    <div className="bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
                      <div className="text-sm text-slate-600">Total</div>
                      <div className="text-3xl font-bold text-purple-700">{resultados.metricas.total}</div>
                    </div>
                    <div className="bg-white rounded-lg shadow p-4 border-l-4 border-red-500">
                      <div className="text-sm text-slate-600">Alta</div>
                      <div className="text-3xl font-bold text-red-700">{resultados.metricas.porSeveridade.ALTA}</div>
                    </div>
                    <div className="bg-white rounded-lg shadow p-4 border-l-4 border-amber-500">
                      <div className="text-sm text-slate-600">M√©dia</div>
                      <div className="text-3xl font-bold text-amber-700">{resultados.metricas.porSeveridade.MEDIA}</div>
                    </div>
                    <div className="bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
                      <div className="text-sm text-slate-600">Impacto</div>
                      <div className="text-xl font-bold text-green-700">{fmt(resultados.metricas.impactoFinanceiro.total)}</div>
                    </div>
                  </div>

                  {/* SE√á√ÉO 1: Regras com filtros */}
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-lg mb-4">üîç Regras de Valida√ß√£o : Quantidade de Cr√≠ticas</h3>
                    <div className="grid grid-cols-3 gap-3">
                      {Object.entries(resultados.metricas.porRegra).map(([r, q]) => {
                        const isSelected = rubraSelecionada === r;
                        return (
                          <button
                            key={r}
                            onClick={() => setRubraSelecionada(isSelected ? null : r)}
                            className={`p-4 rounded-lg border-2 text-left transition-all ${
                              isSelected 
                                ? 'border-purple-600 bg-purple-50 shadow-md' 
                                : 'border-slate-200 bg-slate-50 hover:border-purple-300'
                            }`}
                          >
                            <div className="font-bold text-purple-700">{r}</div>
                            <div className="text-xs text-slate-600 mt-1">{descricoes[r] || 'Valida√ß√£o'}</div>
                            <div className="text-2xl font-bold mt-2 text-purple-600">{q} <span className="text-sm">cr√≠ticas</span></div>
                          </button>
                        );
                      })}
                    </div>
                  </div>

                  {/* SE√á√ÉO 2: Segmentadores por tipo */}
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-lg mb-4">üìä Segmenta√ß√£o por Tipo de Evento</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                      {Object.entries(rubraSelecionada ? divergPorTipoFiltrado : divergPorTipo).map(([key, data]) => {
                        const isSelected = segmentoSelecionado === key;
                        return (
                          <button
                            key={key}
                            onClick={() => setSegmentoSelecionado(isSelected ? null : key)}
                            className={`p-4 rounded-lg border-2 text-center transition-all ${
                              isSelected 
                                ? 'border-blue-600 bg-blue-50 shadow-md' 
                                : 'border-slate-200 bg-slate-50 hover:border-blue-300'
                            }`}
                          >
                            <div className="text-2xl mb-2">{data.nome.split(' ')[0]}</div>
                            <div className="text-sm font-bold text-slate-700">{data.nome.split(' ').slice(1).join(' ')}</div>
                            <div className="text-3xl font-bold text-blue-600 mt-2">{data.count}</div>
                          </button>
                        );
                      })}
                    </div>
                  </div>

                  {/* SE√á√ÉO 3: Drill-through com tabela customiz√°vel */}
                  <div className="bg-white rounded-xl shadow p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-bold text-lg">üîé Detalhamento de Diverg√™ncias ({divergFiltered.length})</h3>
                      <div className="text-xs text-slate-500">
                        {rubraSelecionada && <span className="bg-purple-100 px-2 py-1 rounded mr-2">{rubraSelecionada}</span>}
                        {segmentoSelecionado && <span className="bg-blue-100 px-2 py-1 rounded">{(rubraSelecionada ? divergPorTipoFiltrado : divergPorTipo)[segmentoSelecionado]?.nome}</span>}
                      </div>
                    </div>

                    {divergFiltered.length === 0 ? (
                      <div className="text-center py-8 text-slate-500">
                        <p>Nenhuma diverg√™ncia encontrada com os filtros aplicados</p>
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm border-collapse">
                          <thead>
                            <tr className="bg-slate-100 border-b-2 border-slate-300">
                              <th className="px-3 py-2 text-left">Regra</th>
                              {colunasVisivel.includes('codigo_folha') && <th className="px-3 py-2 text-left">C√≥digo Folha</th>}
                              {colunasVisivel.includes('matricula') && <th className="px-3 py-2 text-left">Matr√≠cula</th>}
                              {colunasVisivel.includes('tipoEvento') && <th className="px-3 py-2 text-left">Tipo Evento</th>}
                              {colunasVisivel.includes('codigo') && <th className="px-3 py-2 text-left">C√≥digo Evento</th>}
                              {colunasVisivel.includes('nomeEvento') && <th className="px-3 py-2 text-left">Evento</th>}
                              {colunasVisivel.includes('valor') && <th className="px-3 py-2 text-right">Valor</th>}
                              <th className="px-3 py-2 text-center">Severidade</th>
                            </tr>
                          </thead>
                          <tbody>
                            {divergFiltered.map((d, i) => (
                              <tr key={i} className="border-b border-slate-200 hover:bg-slate-50">
                                <td className="px-3 py-2 font-bold text-purple-600">{d.regra}</td>
                                {colunasVisivel.includes('codigo_folha') && <td className="px-3 py-2 font-mono">{d.codigoFolha || 'N/A'}</td>}
                                {colunasVisivel.includes('matricula') && <td className="px-3 py-2 font-mono">{d.matricula}</td>}
                                {colunasVisivel.includes('tipoEvento') && <td className="px-3 py-2">{d.tipoEvento}</td>}
                                {colunasVisivel.includes('codigo') && <td className="px-3 py-2 font-bold">{d.codigoEvento || 'N/A'}</td>}
                                {colunasVisivel.includes('nomeEvento') && <td className="px-3 py-2 text-xs">{d.nomeEvento}</td>}
                                {colunasVisivel.includes('valor') && <td className="px-3 py-2 text-right font-bold">{fmt(d.impacto || 0)}</td>}
                                <td className="px-3 py-2 text-center">
                                  <span className={`px-2 py-1 rounded text-xs font-bold ${
                                    d.severidade === 'ALTA' ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700'
                                  }`}>
                                    {d.severidade}
                                  </span>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>

                  <button onClick={() => { setEtapa('upload'); setResultados(null); }} 
                    className="px-6 py-3 bg-slate-600 hover:bg-slate-700 text-white rounded-lg">
                    ‚Üê Voltar
                  </button>
                </div>
              </div>
            );
          }

          const arqs = [
            { key: 'folha_atual', nome: 'üìÑ Folha Atual' },
            { key: 'folha_anterior', nome: 'üìã Folha Anterior' },
            { key: 'admitidos', nome: 'üëã Admitidos' },
            { key: 'demitidos', nome: 'üíî Demitidos' },
            { key: 'ferias', nome: 'üèñÔ∏è F√©rias' },
            { key: 'licenciados', nome: 'ü•º Licenciados' }
          ];
          
          const ok = arqs.every(a => arquivos[a.key]);

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-8">
              <div className="max-w-6xl mx-auto">
                <h1 className="text-3xl font-bold mb-2">üìä Auditoria Folha Pagamento</h1>
                <p className="text-slate-600 mb-6">Sistema automatizado de auditoria de folha</p>

                <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-3 mb-6 text-sm">
                  üí° Pressione <b>F12</b> para ver logs detalhados
                </div>

                <div className="bg-white rounded-xl p-4 mb-6">
                  <div className="h-2 bg-slate-200 rounded-full">
                    <div className="h-full bg-purple-600 transition-all" 
                      style={{ width: `${(Object.keys(arquivos).length / 6) * 100}%` }}></div>
                  </div>
                  <p className="text-center text-sm mt-2">{Object.keys(arquivos).length}/6</p>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                  {arqs.map(a => (
                    <div key={a.key} className={`border-2 rounded-lg p-4 ${
                      arquivos[a.key] ? 'border-green-300 bg-green-50' : 'border-slate-200 bg-white'
                    }`}>
                      <div className="flex justify-between mb-2">
                        <span className="font-bold text-sm">{a.nome}</span>
                        {arquivos[a.key] && (
                          <button onClick={() => remover(a.key)} className="text-red-600 hover:bg-red-100 p-1 rounded">
                            <X />
                          </button>
                        )}
                      </div>
                      
                      {arquivos[a.key] ? (
                        <div className="bg-white rounded p-2 text-xs space-y-1">
                          <p className="font-semibold truncate">{arquivos[a.key].nome}</p>
                          {stats[a.key] && (
                            <>
                              <div>üìä {stats[a.key].totalRegistros.toLocaleString('pt-BR')}</div>
                              <div>üë• {stats[a.key].colaboradores}</div>
                              {stats[a.key].totalValor && <div>üí∞ {fmt(stats[a.key].totalValor)}</div>}
                            </>
                          )}
                        </div>
                      ) : (
                        <label className="cursor-pointer block">
                          <input type="file" accept=".csv" className="hidden" onChange={(e) => handleUpload(a.key, e)} />
                          <div className="border-2 border-dashed rounded p-3 text-center hover:bg-blue-50">
                            <Upload />
                            <span className="text-xs mt-1 block">CSV</span>
                          </div>
                        </label>
                      )}
                    </div>
                  ))}
                </div>

                <button 
                  disabled={!ok}
                  onClick={executar}
                  className={`w-full py-4 rounded-lg font-bold text-lg ${
                    ok ? 'bg-purple-600 hover:bg-purple-700 text-white' : 'bg-slate-200 text-slate-400 cursor-not-allowed'
                  }`}>
                  ‚ñ∂Ô∏è Executar Auditoria
                </button>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PayrollAuditApp />);
    </script>
</body>
</html>
